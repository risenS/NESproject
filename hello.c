/*
A simple "hello world" example.
Set the screen background color and palette colors.
Then write a message to the nametable.
Finally, turn on the PPU to display video.
*/
#define NES_MIRRORING 0
#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"


const unsigned char nametable[308]={
0x01,0x00,0x01,0x25,0xc8,0xca,0x00,0x01,0x09,0xc2,0x01,0x0a,0x00,0x01,0x08,0xc9,
0xcb,0x00,0x01,0x09,0xb7,0x00,0x01,0x02,0xb7,0x00,0x01,0x03,0xb7,0x00,0x01,0x15,
0xb6,0x00,0x01,0x02,0xb7,0x00,0x01,0x03,0xb7,0x00,0x01,0x1e,0xb7,0x00,0x01,0x0c,
0xc2,0x01,0x08,0x00,0x01,0x03,0xcc,0xce,0x00,0x01,0x02,0xb7,0x00,0x01,0x03,0xb4,
0x01,0x02,0x00,0x01,0x06,0xd4,0xd5,0x00,0x01,0x09,0xcd,0xcf,0x00,0x01,0x02,0xb7,
0x00,0x01,0x03,0xb4,0x01,0x03,0x00,0x01,0x05,0xd4,0xd5,0x00,0x01,0x09,0xf4,0xf6,
0x00,0x01,0x02,0xb7,0x00,0x01,0x03,0xb4,0x01,0x04,0x00,0x01,0x04,0xd4,0xd5,0x00,
0x01,0x09,0xf5,0xf7,0x00,0x01,0x02,0xb6,0x00,0x01,0x03,0xb4,0x01,0x04,0x00,0x01,
0x04,0xd4,0xd5,0x00,0x01,0x0e,0xb7,0x00,0x01,0x03,0xb0,0xb5,0x00,0xb4,0xb4,0x00,
0x01,0x04,0xd4,0xd5,0x00,0x01,0x0e,0xb7,0x00,0x01,0x04,0xb5,0x00,0xb0,0x00,0x01,
0x05,0xd4,0xd5,0x00,0x01,0x0e,0xb8,0x00,0x01,0x04,0xb5,0x00,0x01,0x07,0xd4,0xd5,
0x00,0x01,0x14,0xb5,0x00,0x01,0x07,0xd4,0xd5,0x00,0x01,0x14,0xb5,0x00,0x01,0x07,
0xd4,0xd5,0x00,0x01,0x03,0xfc,0xfe,0x00,0x01,0x03,0xf8,0xfa,0x00,0x01,0x03,0xfc,
0xfe,0x00,0x01,0x02,0xb5,0x00,0x01,0x07,0xd4,0xd5,0x00,0x01,0x03,0xfd,0xff,0x00,
0x01,0x03,0xf9,0xfb,0x00,0x01,0x03,0xfd,0xff,0x00,0x01,0x02,0xb5,0x00,0x01,0x07,
0xd4,0xd5,0x00,0x01,0x14,0xb5,0x00,0x01,0x07,0xd4,0xd5,0x00,0x01,0x14,0xb5,0x00,
0x01,0x07,0xd4,0xd5,0x00,0x01,0x09,0x90,0x01,0x04,0x00,0x00,0x90,0x00,0x00,0xb2,
0xb5,0xb2,0x00,0x01,0x06,0xd4,0xd5,0x00,0x01,0x06,0x90,0x01,0x0a,0x00,0x00,0xb2,
0xb5,0xb2,0xb2,0x00,0x01,0x05,0xd4,0xd5,0x00,0x01,0x13,0xc3,0x01,0x1f,0xc0,0x01,
0x3e,0xc0,0x01,0x00
};


const unsigned char nametable2[244]={
0x01,0x00,0x01,0x46,0xae,0x00,0x01,0x09,0xae,0x00,0x01,0x0a,0xae,0x00,0x01,0x02,
0xb9,0x00,0x01,0x16,0xb9,0x00,0x01,0x4e,0xc2,0x01,0x05,0x00,0x01,0x11,0xf4,0xf6,
0x00,0x01,0x05,0xb3,0x00,0x01,0x03,0xc2,0x01,0x06,0x00,0x01,0x0b,0xf5,0xf7,0x00,
0x01,0x05,0xb3,0x00,0x01,0x03,0xb7,0x00,0x01,0x07,0xae,0x00,0x01,0x02,0xc2,0x00,
0x01,0x0c,0xb3,0x00,0x01,0x03,0xb7,0x00,0x01,0x0b,0xc2,0x00,0x01,0x0c,0xb3,0x00,
0x01,0x03,0xb7,0x00,0x01,0x0b,0xc2,0x00,0x01,0x0c,0xb1,0x00,0x01,0x03,0xb6,0x00,
0x01,0x0b,0xc2,0x00,0x01,0x11,0xb3,0x00,0x01,0x08,0xc2,0x01,0x03,0x00,0x01,0x11,
0xb3,0x00,0x01,0x08,0xc2,0x00,0x01,0x0a,0xae,0x00,0x01,0x03,0xc8,0xca,0x00,0x01,
0x02,0xb3,0x00,0x01,0x08,0xc2,0x00,0x01,0x05,0xc2,0x00,0x01,0x08,0xc9,0xcb,0x00,
0x01,0x02,0xb1,0x00,0x01,0x08,0xc2,0x00,0x01,0x05,0xc2,0x00,0x01,0x12,0xc2,0x01,
0x05,0x00,0x01,0x05,0xc2,0x00,0x01,0x1e,0xc2,0x01,0x02,0x00,0x01,0x1e,0xc2,0x00,
0x01,0x1e,0xc2,0x00,0x01,0x0c,0xae,0x00,0x01,0x10,0xc2,0x01,0x05,0x00,0x01,0x15,
0xb9,0x00,0x01,0x03,0xb3,0x00,0x01,0x02,0xc2,0x00,0x01,0x1a,0xb3,0x00,0x01,0x02,
0xc2,0xc2,0x00,0x01,0x19,0xb3,0x00,0x01,0x03,0xc2,0x01,0x07,0x00,0x01,0x12,0xb6,
0x00,0x01,0x2b,0xb9,0x00,0x01,0x05,0xc2,0x01,0x05,0x00,0x01,0x23,0xb9,0x00,0x01,
0x3c,0x00,0x01,0x00
};




// link the pattern table into CHR ROM
//#link "potential.c"
//#link "chr_generic.s"
//#link "vrambuf.c"

///// METASPRITES
#define TILE 0xd8
#define ATTR 0

void handle_pad(int* pos_x, int* pos_y, int* cam_x, int* cam_y)
 {
    char pad_result = pad_poll(0);
  
  if(pad_result & 128) // Right
    {
      if(*cam_x < 0 && *pos_x == 120)
        *cam_x += 1;
      else
      {
        if(*pos_x + 8 < 240)
          *pos_x += 1;
      }
    }
  if(pad_result & 64) // Left
    {
      if(*cam_x > -8 && *pos_x == 120)
      	*cam_x -= 1;
      else
      {
        if(*pos_x - 8 > 0)
          *pos_x -= 1;
      }
    }
  if(pad_result & 32) // Down
    {
      if(*cam_y < 0 && *pos_y == 100)
        *cam_y += 1;
      else
      {
        if(*pos_y + 64 < 240)
          *pos_y += 1;
      }
    }
  if(pad_result & 16) // Up
    {
      if(*cam_y > -292 && *pos_y == 100)
      	*cam_y -= 1;
      else
      {
        if(*pos_y - 8 > 0)
          *pos_y -= 1;
      }
    }
  if(pad_result & 8) // Start
    {
    }
  if(pad_result & 4) // Select
    {
    }
  if(pad_result & 2) // B
    {
    }
  if(pad_result & 1) // A
    {
    }
  return;
 }

// main function, run after console reset
void main(void) {
  int player_x = 120;
  int player_y = 100;
  int cam_x = 0;
  int cam_y = 0;
  int dir_y = 1;
  char attributes = 0;
  
  unsigned char metasprite[]={
    0, 0, TILE+0, ATTR,
    0, 8, TILE+1, ATTR,
    8, 0, TILE+2, ATTR,
    8, 8, TILE+3, ATTR,
    128};
  
  unsigned char metasprite2[]={
    8, 0, TILE+0, 0x40,
    8, 8, TILE+1, 0x40,
    0, 0, TILE+2, 0x40,
    0, 8, TILE+3, 0x40,
    128};
  
  // set palette colors.
  pal_col(0,0x06);	// set screen to dark blue
  pal_col(1,0x17);	// fuchsia
  pal_col(2,0x28);	// grey
  pal_col(3,0x0f);	// white
  
  // Character palette colors.
  pal_col(17, 0x11);
  pal_col(18, 0x2d);
  pal_col(19, 0x32);
  
  vram_adr(NTADR_A(0, 0));
  vram_unrle(nametable);
  
  vram_adr(NTADR_C(0, 0));
  vram_unrle(nametable2);
  
  // enable PPU rendering (turn on screen)
  ppu_on_all();
  
  vrambuf_clear();
  set_vram_update(updbuf);
  
  // infinite loop
  while (1)
  {
    char cur_oam = 0;
      
    handle_pad(&player_x, &player_y, &cam_x, &cam_y);
    
    oam_meta_spr(player_x, player_y, attributes, metasprite); 
    
    vrambuf_flush();
    
    scroll(cam_x, cam_y);
  }
}
