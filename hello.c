/*
A simple "hello world" example.
Set the screen background color and palette colors.
Then write a message to the nametable.
Finally, turn on the PPU to display video.
*/
#define NES_MIRRORING 0
#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"



const unsigned char nametable[514]={
0x03,0x17,0x03,0x08,0x18,0x2f,0x2f,0x0b,0x0b,0x2f,0x2f,0x1b,0x2f,0x1b,0x2f,0x2f,
0x1b,0x2f,0x03,0x04,0x06,0x17,0x03,0x0c,0x18,0x2f,0x2f,0x0b,0x0b,0x2f,0x2f,0x1b,
0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,0x03,0x02,0x06,0x07,0x17,0x03,0x0b,0x18,0x2f,0x03,
0x04,0x0b,0x2f,0x2f,0x1b,0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,0x03,0x02,0x1b,0x26,0x17,
0x03,0x0b,0x18,0x2f,0x03,0x04,0x0b,0x2f,0x2f,0x1b,0x2f,0x1b,0x2f,0x2f,0x66,0x2f,
0x03,0x02,0x1b,0x2f,0x00,0x01,0x01,0x17,0x17,0x01,0x03,0x09,0x32,0x2f,0x03,0x04,
0x1b,0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,0x03,0x02,0x1b,0x2f,0x10,0x11,0x11,0x01,0x01,
0x10,0x11,0x17,0x03,0x07,0x18,0x2f,0x03,0x04,0x1b,0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,
0x03,0x02,0x1b,0x2f,0x20,0x11,0x03,0x03,0x10,0x11,0x17,0x03,0x07,0x07,0x08,0x2f,
0x03,0x03,0x49,0x4a,0x4b,0x2f,0x2f,0x1b,0x2f,0x03,0x02,0x1b,0x2f,0x1e,0x20,0x11,
0x03,0x02,0x10,0x11,0x17,0x03,0x09,0x07,0x07,0x2f,0x03,0x06,0x1b,0x2f,0x03,0x02,
0x1b,0x2f,0x03,0x02,0x10,0x11,0x11,0x10,0x11,0x17,0x17,0x3b,0x3e,0x17,0x03,0x06,
0x18,0x2f,0x03,0x06,0x4e,0x2f,0x03,0x02,0x4f,0x2f,0x03,0x02,0x20,0x11,0x11,0x10,
0x11,0x17,0x17,0x3e,0x3b,0x17,0x21,0x01,0x03,0x04,0x02,0x2f,0x03,0x06,0x5d,0x44,
0x45,0x47,0x5e,0x2f,0x03,0x03,0x10,0x11,0x10,0x11,0x3b,0x3e,0x3b,0x3e,0x3b,0x3e,
0x11,0x21,0x12,0x12,0x1e,0x1b,0x2f,0x03,0x0f,0x10,0x11,0x10,0x11,0x3e,0x3b,0x3e,
0x3b,0x3e,0x3b,0x11,0x11,0x12,0x22,0x2f,0x1b,0x2f,0x03,0x0f,0x20,0x11,0x10,0x11,
0x14,0x14,0x3b,0x3e,0x17,0x17,0x11,0x21,0x12,0x2f,0x2f,0x1b,0x2f,0x03,0x10,0x10,
0x10,0x11,0x17,0x17,0x3e,0x3b,0x17,0x17,0x11,0x11,0x22,0x2f,0x2f,0x67,0x2f,0x03,
0x0c,0x2c,0x39,0x2c,0x2f,0x20,0x10,0x11,0x17,0x17,0x3b,0x3e,0x14,0x14,0x12,0x63,
0x2f,0x03,0x0e,0x2c,0x39,0x03,0x02,0x2c,0x2c,0x2f,0x10,0x11,0x17,0x17,0x3e,0x3b,
0x17,0x17,0x12,0x2f,0x03,0x0f,0x2c,0x03,0x02,0x39,0x39,0x2c,0x2f,0x10,0x11,0x17,
0x17,0x3b,0x3e,0x17,0x17,0x12,0x2f,0x03,0x03,0x45,0x46,0x45,0x03,0x03,0x46,0x45,
0x2f,0x03,0x03,0x0b,0x39,0x2c,0x03,0x02,0x39,0x2f,0x10,0x11,0x17,0x03,0x05,0x12,
0x2f,0x03,0x04,0x48,0x2f,0x1f,0x2f,0x2f,0x48,0x2f,0x03,0x04,0x0b,0x2f,0x1e,0x3c,
0x2f,0x39,0x2f,0x10,0x11,0x14,0x14,0x17,0x03,0x03,0x22,0x2f,0x03,0x04,0x48,0x2f,
0x1f,0x2f,0x2f,0x48,0x2f,0x03,0x07,0x3c,0x2f,0x0b,0x2f,0x10,0x11,0x17,0x03,0x05,
0x18,0x2f,0x03,0x04,0x48,0x2f,0x1f,0x2f,0x2f,0x48,0x2f,0x03,0x07,0x3c,0x2f,0x03,
0x02,0x10,0x21,0x17,0x03,0x05,0x28,0x2f,0x2d,0x2f,0x2f,0x1d,0x0a,0x2d,0x1f,0x2e,
0x2f,0x48,0x2f,0x03,0x07,0x3c,0x2f,0x03,0x02,0x6d,0x03,0x11,0x6e,0x09,0x2e,0x2f,
0x03,0x04,0x6c,0x6d,0x6d,0x6e,0x2f,0x03,0x14,0x6d,0x6e,0x2f,0x2f,0x2d,0x2f,0x2f,
0x6f,0x2f,0x03,0x02,0x6e,0x2e,0x2f,0x03,0x14,0x6d,0x03,0x04,0x2f,0x03,0x04,0x6d,
0x03,0x00
};

const unsigned char nametable2[513]={
0x01,0x2f,0x01,0x04,0x11,0x17,0x01,0x14,0x11,0x2f,0x2f,0x39,0x39,0x2f,0x01,0x04,
0x11,0x17,0x01,0x03,0x3b,0x17,0x01,0x0a,0x3b,0x17,0x01,0x03,0x11,0x2f,0x2f,0x0b,
0x39,0x2f,0x01,0x02,0x00,0x11,0x11,0x17,0x01,0x03,0x3b,0x3e,0x3e,0x3b,0x3e,0x01,
0x07,0x3b,0x17,0x01,0x03,0x11,0x2f,0x2f,0x0b,0x2f,0x2f,0x0d,0x2f,0x11,0x17,0x01,
0x05,0x3b,0x17,0x17,0x3b,0x17,0x01,0x04,0x3b,0x17,0x17,0x3b,0x17,0x01,0x03,0x11,
0x02,0x2f,0x01,0x03,0x00,0x11,0x11,0x17,0x01,0x05,0x3b,0x17,0x17,0x3b,0x17,0x04,
0x01,0x02,0x17,0x3b,0x17,0x17,0x3b,0x17,0x01,0x03,0x14,0x11,0x2f,0x01,0x03,0x11,
0x17,0x01,0x05,0x3e,0x01,0x10,0x17,0x01,0x02,0x11,0x2f,0x01,0x03,0x11,0x17,0x17,
0x36,0x37,0x17,0x01,0x03,0x3b,0x17,0x01,0x0a,0x3b,0x17,0x01,0x04,0x11,0x2f,0x01,
0x03,0x11,0x17,0x17,0x42,0x43,0x17,0x01,0x03,0x3b,0x17,0x01,0x0a,0x3b,0x17,0x01,
0x04,0x11,0x2f,0x01,0x02,0x11,0x11,0x17,0x01,0x19,0x11,0x02,0x2f,0x2f,0x17,0x01,
0x07,0x04,0x01,0x03,0x17,0x01,0x02,0x27,0x01,0x02,0x17,0x17,0x04,0x01,0x03,0x17,
0x01,0x04,0x11,0x2d,0x2f,0x17,0x01,0x0d,0x28,0x2f,0x01,0x02,0x26,0x17,0x01,0x09,
0x11,0x02,0x2f,0x17,0x01,0x0b,0x18,0x2f,0x01,0x06,0x16,0x17,0x01,0x08,0x11,0x11,
0x14,0x01,0x0c,0x44,0x45,0x45,0x46,0x45,0x45,0x47,0x14,0x01,0x04,0x05,0x17,0x01,
0x03,0x4e,0x17,0x14,0x01,0x02,0x25,0x18,0x1b,0x1b,0x16,0x17,0x01,0x04,0x08,0x2f,
0x2f,0x48,0x2f,0x2f,0x06,0x17,0x01,0x02,0x18,0x1b,0x23,0x14,0x05,0x17,0x17,0x5d,
0x17,0x01,0x04,0x18,0x1b,0x1b,0x16,0x17,0x01,0x05,0x08,0x2f,0x48,0x2f,0x06,0x17,
0x01,0x03,0x18,0x1b,0x1b,0x16,0x14,0x05,0x17,0x01,0x06,0x18,0x1b,0x1b,0x16,0x17,
0x18,0x16,0x17,0x01,0x02,0x18,0x2f,0x48,0x2f,0x16,0x17,0x01,0x03,0x18,0x1b,0x1b,
0x16,0x17,0x14,0x01,0x03,0x17,0x01,0x03,0x18,0x1b,0x1b,0x16,0x17,0x18,0x16,0x17,
0x01,0x02,0x18,0x2f,0x48,0x2f,0x16,0x17,0x01,0x03,0x18,0x1b,0x1b,0x16,0x17,0x17,
0x14,0x01,0x02,0x17,0x01,0x03,0x07,0x01,0x03,0x17,0x28,0x16,0x17,0x01,0x02,0x18,
0x2f,0x48,0x2f,0x16,0x17,0x01,0x03,0x07,0x01,0x03,0x17,0x01,0x02,0x14,0x14,0x17,
0x17,0x18,0x2f,0x01,0x06,0x16,0x17,0x01,0x02,0x18,0x13,0x14,0x01,0x04,0x15,0x17,
0x01,0x0c,0x08,0x2f,0x01,0x05,0x03,0x04,0x04,0x14,0x01,0x03,0x0c,0x1b,0x2f,0x1e,
0x14,0x15,0x17,0x01,0x0c,0x08,0x2f,0x01,0x05,0x13,0x14,0x14,0x1e,0x2f,0x1b,0x2f,
0x1b,0x2f,0x2f,0x1b,0x14,0x01,0x03,0x15,0x17,0x01,0x08,0x18,0x2f,0x01,0x06,0x0b,
0x0b,0x2f,0x2f,0x1b,0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,0x01,0x02,0x14,0x15,0x17,0x01,
0x02,0x07,0x01,0x08,0x08,0x2f,0x01,0x03,0x0b,0x0b,0x2f,0x2f,0x1b,0x2f,0x1b,0x2f,
0x2f,0x1b,0x2f,0x01,0x03,0x16,0x17,0x01,0x0c,0x18,0x2f,0x01,0x02,0x0b,0x0b,0x2f,
0x2f,0x1b,0x2f,0x1b,0x2f,0x2f,0x1b,0x2f,0x01,0x03,0x16,0x17,0x01,0x03,0x17,0x01,
0x00
};




// link the pattern table into CHR ROM
//#link "potential.s"
//#link "vrambuf.c"

///// METASPRITES
#define TILE 0x20
#define ATTR 0
#define ACCELERATION 1
#define MAX_VEL 2

struct player_attr
  {
  short pos_x;
  short pos_y;
  short vel_x;
  short vel_y;
  short cam_x;
  short cam_y;
  };

void handle_pad(struct player_attr* player)
 {
  char pad_result = pad_poll(0);
 
  
  if(pad_result & PAD_RIGHT)
    {
     if(player->cam_x < 8 && player->pos_x > 120)
      {
        player->cam_x += 1;
      }
      else if(player->pos_x < 232)
        player->pos_x += 1;
    }
  if(pad_result & PAD_LEFT)
    {
     if(player->cam_x > -8 && player->pos_x < 120)
      {
        player->cam_x -= 1;
      }
      else if(player->pos_x > 8)
        player->pos_x -= 1;
    }
  if(pad_result & PAD_DOWN)
    {
      if(player->cam_y < 256 && player->pos_y > 100)
      {
        player->cam_y += 1;
      }
      else if(player->pos_y < 160)
        player->pos_y += 1;
    }
  if(pad_result & PAD_UP)
    {
      if(player->cam_y > 0 && player->pos_y < 100)
      {
          player->cam_y -= 1;    
      }
      else if(player->pos_y > 48)
        player->pos_y -= 1;
    }
  if(pad_result & PAD_START)
    {
    }
  if(pad_result & PAD_SELECT)
    {
    }
  if(pad_result & PAD_B)
    {
    }
  if(pad_result & PAD_A)
    {
    	player->vel_y -= ACCELERATION * 2;
    }
  return;
 }

// main function, run after console reset
void main(void) {
  
  struct player_attr p1 = {120, 100, 0, 0, 0, 256};
  
  char attributes = 0;
  
  unsigned char metasprite[]={
    0, 0, TILE+0, ATTR,
    0, 8, TILE+16, ATTR,
    128};
  
  unsigned char metasprite2[]={
    8, 0, TILE+0, 0x40,
    8, 8, TILE+1, 0x40,
    128};
  
  // set palette colors.
  pal_col(0,0x0F);	
  pal_col(1,0x0C);	
  pal_col(2,0x2E);	
  pal_col(3,0x06);
  
  // Character palette colors.
  pal_col(17, 0x0d);
  pal_col(18, 0x36);
  pal_col(19, 0x28);
  //pal_col(20, 0x19);
  
  bank_bg(0);
  
  vram_adr(NTADR_A(0, 6));
  vram_unrle(nametable2);
  
  vram_adr(NTADR_C(0, 0));
  vram_unrle(nametable);
  
  vram_adr(NTADR_A(0, 24));
  //vram_fill(0xEE, 128);
  
  // enable PPU rendering (turn on screen)
  
  oam_clear();
  
  vrambuf_clear();
  set_vram_update(updbuf);
  
  ppu_on_all();
  
  // infinite loop
  while (1)
  {
    char cur_oam = 0;
      
    handle_pad(&p1);
    
    bank_spr(1);
    oam_meta_spr(p1.pos_x, p1.pos_y, attributes, metasprite); 
    
    vrambuf_flush();
    
    scroll(p1.cam_x, p1.cam_y);
  }
}
