/*
A simple "hello world" example.
Set the screen background color and palette colors.
Then write a message to the nametable.
Finally, turn on the PPU to display video.
*/
#define NES_MIRRORING 0
#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"



const unsigned char new_level_a[662]={
0x00,0x89,0xff,0x00,0x02,0xee,0xef,0xff,0x00,0x02,0xee,0xef,0xef,0xff,0x00,0x02,
0xee,0xee,0xef,0x00,0x03,0xff,0xee,0xef,0x00,0x07,0xff,0xee,0x00,0x03,0xef,0xff,
0xef,0xee,0xee,0xef,0xff,0xff,0xef,0xee,0xef,0xfe,0xfe,0xff,0xef,0xff,0xff,0xef,
0xfe,0xff,0x00,0x06,0xef,0xef,0xee,0x00,0x02,0x89,0xff,0xff,0xee,0xef,0xee,0xef,
0xfe,0xff,0xff,0xd1,0xd4,0xef,0xef,0xfe,0xff,0xef,0xfe,0x89,0xef,0xfe,0xff,0xef,
0x33,0xff,0xee,0xfe,0xff,0x00,0x02,0xee,0xfe,0xff,0xff,0xee,0xef,0xee,0xef,0xff,
0xee,0xef,0xff,0xe1,0xd0,0xff,0xff,0xee,0xfe,0xff,0xff,0xfe,0xff,0xfe,0xff,0xee,
0x00,0x02,0xfe,0xfe,0xff,0xfe,0xff,0xee,0xee,0xef,0x33,0xee,0xef,0xee,0xef,0xff,
0xee,0xef,0xef,0xe1,0xd0,0xff,0xee,0xfe,0x89,0xff,0xee,0xfe,0xff,0xff,0xfe,0x00,
0x03,0xff,0xee,0xef,0x89,0xfe,0xee,0xee,0xef,0xee,0xef,0xff,0xfe,0xff,0xee,0xfe,
0xff,0xff,0xe1,0xd0,0xee,0xfe,0xee,0xfe,0xff,0xee,0xfe,0xff,0x00,0x02,0xef,0xef,
0xee,0x00,0x03,0xfe,0xff,0xee,0xee,0xef,0xee,0x00,0x02,0xef,0xfe,0xee,0xee,0xfe,
0xff,0xe1,0xd6,0xc3,0xc2,0xc3,0x00,0x03,0xc2,0x00,0x02,0xc3,0xc3,0xc2,0xc3,0xc5,
0xee,0xfe,0xff,0xff,0xee,0xee,0xef,0xfe,0xfe,0xee,0xef,0xee,0x22,0xfe,0xfe,0xff,
0xc7,0xd3,0xd3,0xd2,0xd3,0xd3,0xd2,0x00,0x02,0xd3,0xd3,0xd2,0x00,0x02,0xd4,0xe5,
0xfe,0xff,0x00,0x02,0xee,0xfe,0xee,0x00,0x03,0xef,0xee,0xfe,0xfe,0xff,0xee,0x00,
0x02,0xef,0xfe,0xfe,0xff,0xff,0xee,0xef,0xfe,0xff,0xfe,0xfe,0xff,0xe1,0xe5,0xee,
0xef,0xff,0x01,0x05,0xef,0xfe,0x00,0x02,0xee,0x00,0x02,0xef,0xfe,0xff,0xfe,0x00,
0x02,0xff,0xff,0xee,0xef,0xef,0xee,0xee,0xfe,0xff,0xee,0xee,0xef,0xe1,0xe5,0xee,
0xef,0xff,0x14,0x25,0xee,0xef,0xef,0xee,0xfe,0x00,0x02,0xff,0xef,0xff,0x00,0x02,
0xee,0xef,0xee,0xef,0xef,0xff,0xc0,0xc1,0xff,0xee,0xf3,0xfe,0xff,0xe1,0xe5,0xee,
0xef,0xff,0x34,0x45,0xee,0xee,0xef,0xfe,0xff,0x00,0x02,0xfe,0xff,0xef,0x00,0x02,
0x89,0xef,0xee,0x00,0x03,0xc6,0xd1,0xe2,0xfe,0xff,0xf3,0xfe,0xe1,0xe5,0xee,0xef,
0xff,0x34,0x25,0xfe,0xfe,0xee,0xef,0xee,0xef,0xfe,0x00,0x02,0xff,0x00,0x02,0xee,
0xee,0xfe,0x00,0x03,0xc6,0xe1,0xf2,0xfe,0xff,0xfe,0xf2,0xe1,0xe5,0xee,0xef,0xff,
0x34,0x25,0xef,0xee,0xfe,0xff,0xfe,0xff,0xee,0xef,0xee,0xef,0xee,0xee,0xfe,0x00,
0x05,0xc6,0xe1,0xff,0xee,0xf2,0xee,0xee,0xe1,0xe5,0xee,0x89,0xff,0x34,0x55,0x02,
0x02,0x03,0x03,0x04,0x05,0xfe,0xff,0xfe,0xff,0xfe,0x00,0x02,0xff,0xef,0x00,0x03,
0xc6,0xd3,0xc8,0xc8,0xd3,0xc8,0xd3,0xc7,0xe5,0xef,0x00,0x02,0x44,0x13,0x12,0x12,
0x13,0x13,0x14,0x15,0xee,0xee,0xfe,0xff,0xef,0x33,0xef,0x00,0x05,0xd6,0xd9,0x00,
0x06,0xdb,0xff,0x00,0x03,0xee,0x20,0x11,0x14,0x22,0x24,0x25,0xfe,0x00,0x02,0xff,
0xff,0xfe,0xff,0x00,0x07,0xfe,0xff,0xfe,0xff,0xfe,0xff,0xfe,0xff,0xfe,0xfe,0xff,
0xee,0x30,0x31,0x44,0x33,0x24,0x15,0xef,0x00,0x03,0xfe,0x00,0x02,0xee,0xee,0xef,
0xee,0xee,0xfe,0xff,0x00,0x09,0xef,0xee,0xee,0x30,0x41,0x43,0x43,0x44,0x45,0xee,
0x00,0x02,0x89,0xee,0x00,0x02,0xfe,0xfe,0xff,0xfe,0x33,0xfe,0xff,0xee,0x00,0x06,
0xfe,0xff,0x89,0xee,0xfe,0x50,0x52,0x00,0x02,0x54,0x55,0xfe,0x00,0x12,0x89,0xfe,
0x00,0x02,0xff,0xee,0x00,0x08,0xfe,0xee,0xee,0xef,0x00,0x11,0xfe,0xff,0x09,0x08,
0x07,0x08,0x08,0x09,0x09,0x0a,0x09,0x09,0x0a,0x0a,0x07,0x09,0x0a,0x07,0x0a,0x09,
0x08,0x09,0x07,0x08,0x00,0x02,0x07,0x09,0x00,0x02,0x07,0x09,0x07,0x09,0x18,0x18,
0x19,0x00,0x0c,0x18,0x19,0x00,0x04,0x18,0x18,0x19,0x00,0x03,0x18,0x19,0x19,0x18,
0x19,0xfe,0xfe,0xee,0x00,0x02,0xfe,0x00,0x04,0xff,0xfe,0x00,0x02,0xff,0xfe,0x00,
0x0d,0xff,0xff,0xee,0x00,0x00
};




// link the pattern table into CHR ROM
//#link "potential.s"
//#link "vrambuf.c"

///// METASPRITES
#define TILE 0xE0
#define ATTR 0

void handle_pad(int* pos_x, int* pos_y, int* cam_x, int* cam_y)
 {
  char pad_result = pad_poll(0);
  
  
  if(*cam_y < 0 && *pos_y == 100)
      *cam_y += 2;
    else
    {
      if(*pos_y + 64 < 240)
        *pos_y += 2;
    }
  
  if(pad_result & PAD_RIGHT)
    {
      if(*cam_x < 0 && *pos_x == 120)
        *cam_x += 1;
      else
      {
        if(*pos_x + 8 < 240)
          *pos_x += 1;
      }
    }
  if(pad_result & PAD_LEFT)
    {
      if(*cam_x > -8 && *pos_x == 120)
      	*cam_x -= 1;
      else
      {
        if(*pos_x - 8 > 0)
          *pos_x -= 1;
      }
    }
  if(pad_result & PAD_DOWN)
    {
    }
  if(pad_result & PAD_UP)
    {
    }
  if(pad_result & PAD_START)
    {
    }
  if(pad_result & PAD_SELECT)
    {
    }
  if(pad_result & PAD_B)
    {
    }
  if(pad_result & PAD_A)
    {
    	if(*cam_y > -276 && *pos_y == 100)
    	  *cam_y -= 4;
    	else
    	{
    	  if(*pos_y > 8)
    	    *pos_y -= 4;
    	}
    }
  return;
 }

// main function, run after console reset
void main(void) {
  int player_x = 120;
  int player_y = 100;
  int cam_x = 0;
  int cam_y = 0;
  int dir_y = 1;
  char attributes = 0;
  
  unsigned char metasprite[]={
    0, 0, TILE+0, ATTR,
    0, 8, TILE+1, ATTR,
    8, 0, TILE+2, ATTR,
    8, 8, TILE+3, ATTR,
    128};
  
  unsigned char metasprite2[]={
    8, 0, TILE+0, 0x40,
    8, 8, TILE+1, 0x40,
    0, 0, TILE+2, 0x40,
    0, 8, TILE+3, 0x40,
    128};
  
  // set palette colors.
  pal_col(0,0x14);	
  pal_col(1,0x08);	
  pal_col(2,0x00);	
  pal_col(3,0x19);
  
  // Character palette colors.
  pal_col(17, 0x0d);
  pal_col(18, 0x37);
  pal_col(19, 0x17);
  //pal_col(20, 0x19);
  
  bank_bg(0);
  
  vram_adr(NTADR_A(0, 0));
  vram_unrle(new_level_a);
  
  vram_adr(NTADR_C(0, 0));
  //vram_unrle(new_level_b);
  vram_fill(0xEE, 960);
  
  vram_adr(NTADR_A(0, 24));
  vram_fill(0xEE, 128);
  
  // enable PPU rendering (turn on screen)
  
  oam_clear();
  
  vrambuf_clear();
  set_vram_update(updbuf);
  
  ppu_on_all();
  
  // infinite loop
  while (1)
  {
    char cur_oam = 0;
      
    handle_pad(&player_x, &player_y, &cam_x, &cam_y);
    
    bank_spr(1);
    oam_meta_spr(player_x, player_y, attributes, metasprite); 
    
    vrambuf_flush();
    
    scroll(cam_x, cam_y);
  }
}
